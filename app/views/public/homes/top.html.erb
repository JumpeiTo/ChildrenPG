<div class="row">
  <div class="col-4">
    
    <h2>遊び場検索</h2>
    <%= form_with(url: places_search_path, method: :get, id: 'filter-search_form') do |f| %>
        <p id="error-text">マップで検索したい場所に<br>ピンをさしてください</p>
        <div class="d-flex">
          <label for="pin-coordinates-lat">緯度:</label>
          <div id="pin-coordinates-lat"></div> <!-- ピンの緯度を表示する要素 -->
        </div>
        <div class="d-flex">
          <label for="pin-coordinates-lng">経度:</label>
          <div id="pin-coordinates-lng"></div> <!-- ピンの経度を表示する要素 -->
        </div>
      <%= f.label :name, '遊び場名' %>
      <%= f.text_field :name, placeholder: '遊び場名を入力してください' %></br>
      <%= f.label :types, 'カテゴリー' %>
      <%= f.select :types, options_for_select([['カテゴリー選択', nil], ['公園', 'park'], ['観光名所', 'tourist_attraction'], ['遊園地', 'amusement_park'], ['空港', 'airport'], ['水族館', 'aquarium'], ['美術館', 'art_gallery'], ['書店', 'book_store'], ['ボウリング場', 'bowling_alley'], ['カフェ', 'cafe'], ['キャンプ場', 'campground'], ['デパート', 'department_store'], ['図書館', 'library'], ['映画館', 'movie_theater'], ['博物館', 'museum'], ['ペットショップ', 'pet_store'], ['学校', 'school'], ['レストラン', 'restaurant'], ['ショッピングモール', 'shopping_mall'], ['スタジアム', 'stadium'], ['店舗', 'store'], ['動物園', 'zoo']]), {} %></br>
      <%= f.label :radius, '範囲' %>
      <%= f.select :radius, options_for_select([['範囲選択', nil], ['1Km','1000'], ['5Km','5000'], ['10Km','10000'], ['30Km','30000']]) %></br>
      <%= f.hidden_field :lat, id: 'lat' %>
      <%= f.hidden_field :lng, id: 'lng' %>
      
      <%= f.submit '検索', id: "submit_button" %>
      <p id="error_message" style="display: none;">ピンを作成してください</p>

    <% end %>

  </div>
  
  <div class="col-8">
    <input id="address" type="textbox" placeholder="場所を入力してください" >
    <input type="button" value="探す" onclick="codeAddress()">
    <p>マップ上で左クリック長押しするとピンが表示されます。</p>
    <p>ピンをドラック＆ドロップで位置の調整ができます。<p>
    <div id="map"></div>
    
    <style>
      #map {
        height: 450px;
        width: 700px;
      }
    </style>
    
    <script>
      let map;
      let marker;
      let geocoder;
      
      
      function initMap() {
        geocoder = new google.maps.Geocoder();
        
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 35.155396, lng: 136.918969 },　// マップ表示時のデフォルト位置(名古屋の鶴舞公園)
          zoom: 12, // デフォルトズーム倍率
        });
        
        google.maps.event.addListener(map, "click", function(event) {
          //マーカーが複数できないようにする
          if (marker) {
            marker.setMap(null); 
          }
          marker = new google.maps.Marker({
            position: event.latLng,
            map: map,
            draggable: true,
          });
          document.getElementById("lat").value = event.latLng.lat();
          document.getElementById("lng").value = event.latLng.lng();
          displayPinCoordinates(event.latLng.lat(), event.latLng.lng()); // ピンの緯度経度を表示
          google.maps.event.addListener(marker, "dragend", function(event) {
            document.getElementById("lat").value = this.getPosition().lat();
            document.getElementById("lng").value = this.getPosition().lng();
            displayPinCoordinates(this.getPosition().lat(), this.getPosition().lng()); // ピンの緯度経度を表示
          });
        });
      }
      
      function codeAddress() {
        let inputAddress = document.getElementById("address").value;
        geocoder.geocode({ address: inputAddress }, function(results, status) {
          if (status == "OK") {
            if (marker) {
              marker.setMap(null);
            }
            map.setCenter(results[0].geometry.location);
            marker = new google.maps.Marker({
              position: results[0].geometry.location,
              map: map,
              draggable: true,
            });
            document.getElementById("lat").value = results[0].geometry.location.lat();
            document.getElementById("lng").value = results[0].geometry.location.lng();
            displayPinCoordinates(results[0].geometry.location.lat(), results[0].geometry.location.lng()); // ピンの緯度経度を表示
            google.maps.event.addListener(marker, "dragend", function(event) {
              document.getElementById("lat").value = this.getPosition().lat();
              document.getElementById("lng").value = this.getPosition().lng();
              displayPinCoordinates(this.getPosition().lat(), this.getPosition().lng()); // ピンの緯度経度を表示
            });
          } else {
          }
        });
      }

      function displayPinCoordinates(lat, lng) {
        document.getElementById("pin-coordinates-lat").textContent = lat;
        document.getElementById("pin-coordinates-lng").textContent = lng;
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap" async defer></script>
  </div>
</div>